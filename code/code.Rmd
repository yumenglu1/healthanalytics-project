---
title: "Smoking and Asthma Analysis"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages
```{r}
# Load necessary packages
target_packages <- c("dplyr", "ggplot2", "broom", "tidyr", "srvyr", 
"survey", "ipumsr", "here", "car", "kableExtra", "modelsummary", "margins")

# Check if packages are installed; if not, install them
package.check <- lapply(
  target_packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)
```

## Load & Clean Data
```{r}
# Load dataset
ddi <- read_ipums_ddi("nhis_00010.xml")
data <- read_ipums_micro(ddi)

# Select relevant variables
data_cleaned <- data %>%
  select(SMOKESTATUS2, ASTHMAEV, CIGSDAY2) %>%
  filter(!is.na(SMOKESTATUS2) & !is.na(ASTHMAEV)) %>%
  mutate(
    CIGSDAY2_cleaned = case_when(
      CIGSDAY2 %in% c(97, 98, 99) ~ NA_real_,   # Keep these as NIU
      CIGSDAY2 == 95 ~ 95,                      # Keep 95
      TRUE ~ as.numeric(CIGSDAY2)               # Keep other number
    ),
    # Define smoking status
    Smoking_Status = case_when(
      SMOKESTATUS2 %in% c(10, 11, 12, 13) ~ "Current Smoker",
      SMOKESTATUS2 == 20 ~ "Former Smoker",
      SMOKESTATUS2 == 30 ~ "Never Smoked",
      SMOKESTATUS2 %in% c(40, 90) ~ "Unknown",
      TRUE ~ "Unknown"
    ),
    # Define the number of cigarette for the current smoker
    Smoking_Intensity = case_when(
      Smoking_Status == "Current Smoker" & CIGSDAY2 <= 5 ~ "Current Smoker (Light)",
      Smoking_Status == "Current Smoker" & CIGSDAY2 <= 10 ~ "Current Smoker (Moderate)",
      Smoking_Status == "Current Smoker" & CIGSDAY2 > 10 ~ "Current Smoker (Heavy)",
      TRUE ~ Smoking_Status  
    ),
    Asthma_Attack = if_else(ASTHMAEV == 2, 1, 0)
  ) %>%
  # Set nonsmoker as control group
  mutate(
    Smoking_Intensity = factor(Smoking_Intensity),
    Smoking_Intensity = relevel(Smoking_Intensity, ref = "Never Smoked")
  )
```

## Summary Tables
```{r}
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)

# 1. Ensure Smoking_Intensity is a factor with the desired ordering
data_cleaned <- data_cleaned %>%
  mutate(Smoking_Intensity = factor(Smoking_Intensity, 
                                    levels = c("Never Smoked", "Former Smoker", "Unknown",
                                               "Current Smoker (Light)", "Current Smoker (Moderate)", "Current Smoker (Heavy)")))

# 2. Create a combined summary table grouped by Smoking_Intensity,
#    excluding metrics that are mostly zeros/NA's (e.g. we remove CV_CIGSDAY)
combined_table <- data_cleaned %>%
  group_by(Smoking_Intensity) %>%
  summarise(
    N = n(),
    Asthma_No = sum(Asthma_Attack == 0, na.rm = TRUE),
    Asthma_Yes = sum(Asthma_Attack == 1, na.rm = TRUE),
    Mean_CIGSDAY = mean(CIGSDAY2, na.rm = TRUE),
    SD_CIGSDAY = sd(CIGSDAY2, na.rm = TRUE),
    Median_CIGSDAY = median(CIGSDAY2, na.rm = TRUE),
    IQR_CIGSDAY = IQR(CIGSDAY2, na.rm = TRUE),
    Min_CIGSDAY = min(CIGSDAY2, na.rm = TRUE),
    Max_CIGSDAY = max(CIGSDAY2, na.rm = TRUE),
    Percent_with_Asthma = mean(Asthma_Attack, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# 3. Flip the table so that summary metrics become rows and Smoking_Intensity groups become columns.
#    Then rename the raw metric names to reader-friendly labels.
flipped_table <- combined_table %>%
  pivot_longer(-Smoking_Intensity, names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = dplyr::recode(Metric,
                                "N" = "Sample Size",
                                "Asthma_No" = "Count (No Asthma Attack)",
                                "Asthma_Yes" = "Count (Asthma Attack)",
                                "Mean_CIGSDAY" = "Mean Cigarettes/Day",
                                "SD_CIGSDAY" = "SD Cigarettes/Day",
                                "Median_CIGSDAY" = "Median Cigarettes/Day",
                                "IQR_CIGSDAY" = "Interquartile Range Cigarettes/Day",
                                "Min_CIGSDAY" = "Minimum Cigarettes/Day",
                                "Max_CIGSDAY" = "Maximum Cigarettes/Day",
                                "Percent_with_Asthma" = "Percentage with Asthma Attack"
  )) %>%
  pivot_wider(names_from = Smoking_Intensity, values_from = Value) %>%
  # Round numeric columns to 2 decimal places for a neat output
  mutate(across(where(is.numeric), ~ round(., 2)))

# 4. Add a design touch with kableExtra.
#    Here we also sort the columns based on the factor levels we set earlier.
final_table <- flipped_table %>%
  kable(format = "html", caption = "Combined Summary Table by Smoking Intensity", 
        col.names = colnames(.)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE, position = "center")

# Print the final table
print(final_table)
   
```


## Visualization
```{r}


# Recode Asthma_Attack to be more interpretable
data_cleaned <- data_cleaned %>%
  mutate(Asthma_Attack_Factor = factor(Asthma_Attack, 
                                        levels = c(0,1), 
                                        labels = c("No Asthma Attack", "Asthma Attack")))

# 1. Grouped Bar Chart: Count of Asthma Attacks by Smoking_Intensity
ggplot(data_cleaned, aes(x = Smoking_Intensity, fill = Asthma_Attack_Factor)) +
  geom_bar(position = "dodge") +
  labs(title = "Asthma Attack Frequency by Smoking Intensity", 
       x = "Smoking Intensity", 
       y = "Count", 
       fill = "Asthma Attack") +
  theme_minimal() +
  scale_fill_manual(values = c("#1f78b4", "#33a02c")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 2. Stacked Bar Chart: Proportion of Asthma Attacks by Smoking_Intensity
ggplot(data_cleaned, aes(x = Smoking_Intensity, fill = Asthma_Attack_Factor)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Asthma Attacks by Smoking Intensity", 
       x = "Smoking Intensity", 
       y = "Proportion", 
       fill = "Asthma Attack") +
  theme_minimal() +
  scale_fill_manual(values = c("#1f78b4", "#33a02c")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Statistical Analysis
```{r}
# Chi-Square Test
chi_test <- chisq.test(table(data_cleaned$Smoking_Status, data_cleaned$Asthma_Attack))
chi_test
```

## Logistic Regression Model
```{r}
library(modelsummary)
library(kableExtra)
library(tibble)
library(dplyr)
library(broom)
library(margins)

# Run logistic regression
logit_model <- glm(
  Asthma_Attack ~ Smoking_Intensity, 
  data = data_cleaned, 
  family = binomial()
)

# 1. Calculate the mean Asthma_Attack rate in the "Never Smoked" group
control_group_mean <- data_cleaned %>%
  filter(Smoking_Intensity == "Never Smoked") %>%
  summarise(Mean_Control = mean(Asthma_Attack, na.rm = TRUE)) %>%
  pull(Mean_Control)

# 2. Extract logistic regression results
model_results <- tidy(logit_model, conf.int = TRUE, exponentiate = TRUE)

# 3. Compute marginal effects
marginal_effects <- margins(logit_model)
marginal_summary <- summary(marginal_effects) %>%
  as_tibble()

# Check column names
print(colnames(marginal_summary))  # Identify the correct column name for variable names

# Adjust column selection based on actual output
marginal_summary <- marginal_summary %>%
  select(factor, AME = AME)  # Replace 'factor' if needed with actual column name

# 4. Format p-values properly with four decimal places and significance stars
model_results <- model_results %>%
  mutate(
    stars = case_when(
      p.value < 0.01 ~ "***",
      p.value < 0.05 ~ "**",
      p.value < 0.1  ~ "*",
      TRUE ~ ""
    ),
    `Formatted P-Value` = paste0(sprintf("%.4f", p.value), stars)  # Ensures 4 decimal places
  )

# 5. Merge regression results with marginal effects
merged_results <- model_results %>%
  left_join(marginal_summary, by = c("term" = "factor")) %>%  # Ensure correct join
  mutate(
    Variable = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "Smoking_IntensityCurrent Smoker (Light)" ~ "Current Smoker (Light)",
      term == "Smoking_IntensityCurrent Smoker (Moderate)" ~ "Current Smoker (Moderate)",
      term == "Smoking_IntensityCurrent Smoker (Heavy)" ~ "Current Smoker (Heavy)",
      term == "Smoking_IntensityFormer Smoker" ~ "Former Smoker",
      term == "Smoking_IntensityNever Smoked" ~ "Never Smoked",
      term == "Smoking_IntensityUnknown" ~ "Unknown",
      TRUE ~ term
    ),
    `Mean Value in Control Group` = ifelse(term == "(Intercept)", control_group_mean, NA),
    `Change with Smoking Intensity (95% CI)` = paste0(
      round(estimate, 3), 
      " (", round(conf.low, 3), " to ", round(conf.high, 3), ")"
    ),
    `Average Marginal Effect (AME)` = ifelse(is.na(AME), "", sprintf("%.4f", AME))  # Format AME values
  ) %>%
  select(Variable, `Mean Value in Control Group`, `Change with Smoking Intensity (95% CI)`, `Average Marginal Effect (AME)`, `Formatted P-Value`)

# 6. Convert to kableExtra table
styled_table <- kable(merged_results, format = "html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE, position = "center") %>%
  add_header_above(c(" " = 1, "Logistic Regression Results" = 4)) %>%
  row_spec(0, bold = TRUE, background = "#F8F8F8") %>%
  column_spec(1, width = "5cm") %>%
  column_spec(2, width = "4cm") %>%
  column_spec(3, width = "5cm") %>%
  column_spec(4, width = "4cm") %>%
  column_spec(5, width = "3cm")

print(styled_table)
```

## Residual Plot for Logistic Regression
```{r}
# Extract residuals and fitted values
residuals_data <- data.frame(
  Fitted = fitted(logit_model),
  Residuals = residuals(logit_model)
)

# Plot residuals
ggplot(residuals_data, aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residual Plot: Logistic Regression", x = "Fitted Values", y = "Residuals") +
  theme_minimal()
```

## Predicted Probabilities Distribution
```{r}
# Get predicted probabilities
data_cleaned$pred_prob <- predict(logit_model, type = "response")

# Plot histogram
ggplot(data_cleaned, aes(x = pred_prob)) +
  geom_histogram(binwidth = 0.05, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Distribution of Predicted Probabilities", x = "Predicted Probability", y = "Count")
```

## Marginal Effects for Logistic Regression
```{r}
# Compute marginal effects for logistic regression
marginal_effects <- margins(logit_model)

# Summarize Average Marginal Effects
summary(marginal_effects)
```

## Interpretation
The logistic regression results above provide insights into the relationship between smoking status and the likelihood of having an asthma attack in the past 12 months. The confidence intervals and significance levels indicate the strength of this relationship. Further investigation can include additional covariates to control for confounding factors.