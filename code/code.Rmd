---
title: "Smoking and Asthma Analysis"
author: "Group R: Hanif, Chuanbo, Meihe, Mingzhi, Yumeng"
date: "`r Sys.Date()`"
output: html_document
---

## Initialization & Setup
```{r initialization, include=FALSE}
# Set global chunk options: show code but hide messages and warnings
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# List of required packages
required_packages <- c("dplyr", "ggplot2", "broom", "tidyr", "srvyr", 
                       "survey", "ipumsr", "here", "car", "kableExtra", 
                       "modelsummary", "margins")

# Function to load or install packages if they're missing
load_or_install <- function(pkg) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg, dependencies = TRUE)
    library(pkg, character.only = TRUE)
  }
}

# Load all packages silently
invisible(lapply(required_packages, load_or_install))
```

## Load & Clean Data
```{r load_clean_data}
# Load dataset
ddi <- read_ipums_ddi("nhis_00012.xml")
data <- read_ipums_micro(ddi)

data_cleaned <- data %>%
  # Select only the relevant variables
  select(SMOKESTATUS2, ASTHMAEV, CIGSDAY2, AGE, SEX, EDUC, GOTWAGE, REGION) %>%
  # Remove rows missing key smoking or asthma information
  filter(!is.na(SMOKESTATUS2), !is.na(ASTHMAEV)) %>%
  mutate(
    # Clean cigarettes per day: set NIU codes to NA, keep 95 as is, convert others to numeric
    CIGSDAY2_cleaned = case_when(
      CIGSDAY2 %in% c(97, 98, 99) ~ NA_real_,
      CIGSDAY2 == 95 ~ 95,
      TRUE ~ as.numeric(CIGSDAY2)
    ),
    # Define smoking status based on SMOKESTATUS2 codes
    Smoking_Status = case_when(
      SMOKESTATUS2 %in% c(10, 11, 12, 13) ~ "Current Smoker",
      SMOKESTATUS2 == 20 ~ "Former Smoker",
      SMOKESTATUS2 == 30 ~ "Never Smoked",
      SMOKESTATUS2 %in% c(40, 90) ~ "Unknown",
      TRUE ~ "Unknown"
    ),
    # For current smokers, categorize intensity based on cigarettes per day
    Smoking_Intensity = case_when(
      Smoking_Status == "Current Smoker" & CIGSDAY2 <= 5 ~ "Current Smoker (Light)",
      Smoking_Status == "Current Smoker" & CIGSDAY2 <= 10 ~ "Current Smoker (Moderate)",
      Smoking_Status == "Current Smoker" & CIGSDAY2 > 10 ~ "Current Smoker (Heavy)",
      TRUE ~ Smoking_Status
    ),
    # Recode asthma variable: 1 indicates an asthma attack
    Asthma_Attack = if_else(ASTHMAEV == 2, 1, 0),
    # Recode age: set certain codes to NA or top-code to 85
    age = case_when(
      AGE %in% c(997, 998, 999) ~ NA_real_,
      AGE %in% c(085, 090, 099) ~ 85,
      TRUE ~ as.numeric(AGE)
    ),
    # Convert SEX to a factor with appropriate labels
    gender = factor(case_when(
      SEX == 1 ~ "Male",
      SEX == 2 ~ "Female",
      TRUE ~ NA_character_
    ), levels = c("Male", "Female")),
    # Recode education: group into "Bachelor+" or "No Bachelor"
    education = factor(case_when(
      EDUC %in% c(400, 501, 503, 505) ~ "Bachelor+",
      EDUC %in% c(100:116, 200:303) ~ "No Bachelor",
      TRUE ~ NA_character_
    ), levels = c("No Bachelor", "Bachelor+")),
    # Recode income based on wage status
    income = factor(case_when(
      GOTWAGE == 2 ~ "Yes",
      GOTWAGE == 1 ~ "No",
      TRUE ~ NA_character_
    ), levels = c("No", "Yes")),
    # Map region codes to names
    region = factor(case_when(
      REGION == 1 ~ "Northeast",
      REGION == 2 ~ "Midwest",
      REGION == 3 ~ "South",
      REGION == 4 ~ "West",
      TRUE ~ NA_character_
    ), levels = c("Northeast", "Midwest", "South", "West"))
  ) %>%
  # Remove observations missing any control variable
  filter(!is.na(age), !is.na(gender), !is.na(education), !is.na(income), !is.na(region)) %>%
  # Set reference categories for regression analyses
  mutate(
    Smoking_Intensity = relevel(factor(Smoking_Intensity), ref = "Never Smoked"),
    education = relevel(education, ref = "No Bachelor"),
    income = relevel(income, ref = "No"),
    region = relevel(region, ref = "Northeast")
  )
```

## Descriptive Table: Demographics
```{r descriptive_table_demographics, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(kableExtra)

# Summarize key demographic variables
descriptive_demographics <- data_cleaned %>%
  group_by(Smoking_Intensity) %>%
  summarise(
    Observations      = n(),
    Mean_Age          = mean(age, na.rm = TRUE),
    SD_Age            = sd(age, na.rm = TRUE),
    Prop_Male         = mean(gender == "Male", na.rm = TRUE),
    Prop_Female       = mean(gender == "Female", na.rm = TRUE),
    Prop_BachelorPlus = mean(education == "Bachelor+", na.rm = TRUE),
    Prop_IncomeYes    = mean(income == "Yes", na.rm = TRUE),
    Prop_Asthma       = mean(Asthma_Attack == 1, na.rm = TRUE)
  ) %>%
  ungroup()

# Pivot so that each metric is a row, and each Smoking_Intensity group is a column
descriptive_demographics_long <- descriptive_demographics %>%
  pivot_longer(-Smoking_Intensity, names_to = "Metric", values_to = "Value") %>%
  pivot_wider(names_from = Smoking_Intensity, values_from = Value) %>%
  # Round numeric values for neat display
  mutate(across(where(is.numeric), ~ round(.x, 3)))

# Provide user-friendly labels for each metric
descriptive_demographics_long <- descriptive_demographics_long %>%
  mutate(Metric = dplyr::recode(
    Metric,
    "Observations"      = "Number of Observations",
    "Mean_Age"          = "Mean Age",
    "SD_Age"            = "SD of Age",
    "Prop_Male"         = "% Male",
    "Prop_Female"       = "% Female",
    "Prop_BachelorPlus" = "% with Bachelor+",
    "Prop_IncomeYes"    = "% with Income = Yes",
    "Prop_Asthma"       = "% with Asthma Attack"
  ))

# Render table with consistent kableExtra styling
descriptive_demographics_long %>%
  kable(
    format   = "html",
    caption  = "Descriptive Characteristics by Smoking Intensity (Demographics)",
    col.names = colnames(.)
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position   = "center"
  )
```

## Summary Table: Cigarette Metrics
```{r pivoted_metrics_table, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(kableExtra)

# (Optional) Re-factor Smoking_Intensity to ensure correct column order
data_cleaned <- data_cleaned %>%
  mutate(Smoking_Intensity = factor(
    Smoking_Intensity,
    levels = c("Never Smoked", "Former Smoker", "Unknown",
               "Current Smoker (Light)", "Current Smoker (Moderate)", "Current Smoker (Heavy)")
  ))

# Summarize cigarette-related metrics
combined_table <- data_cleaned %>%
  group_by(Smoking_Intensity) %>%
  summarise(
    N                 = n(),
    Asthma_No         = sum(Asthma_Attack == 0, na.rm = TRUE),
    Asthma_Yes        = sum(Asthma_Attack == 1, na.rm = TRUE),
    Mean_CIGSDAY      = mean(CIGSDAY2_cleaned, na.rm = TRUE),
    SD_CIGSDAY        = sd(CIGSDAY2_cleaned, na.rm = TRUE),
    Median_CIGSDAY    = median(CIGSDAY2_cleaned, na.rm = TRUE),
    IQR_CIGSDAY       = IQR(CIGSDAY2_cleaned, na.rm = TRUE),
    Min_CIGSDAY       = min(CIGSDAY2_cleaned, na.rm = TRUE),
    Max_CIGSDAY       = max(CIGSDAY2_cleaned, na.rm = TRUE),
    Percent_with_Asthma = 100 * mean(Asthma_Attack == 1, na.rm = TRUE),
    .groups = "drop"
  )

# Pivot the table
flipped_table <- combined_table %>%
  pivot_longer(
    cols = -Smoking_Intensity,
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  mutate(Metric = dplyr::recode(
    Metric,
    "N"                   = "Sample Size",
    "Asthma_No"           = "Count (No Asthma Attack)",
    "Asthma_Yes"          = "Count (Asthma Attack)",
    "Mean_CIGSDAY"        = "Mean Cigarettes/Day",
    "SD_CIGSDAY"          = "SD Cigarettes/Day",
    "Median_CIGSDAY"      = "Median Cigarettes/Day",
    "IQR_CIGSDAY"         = "Interquartile Range Cigarettes/Day",
    "Min_CIGSDAY"         = "Minimum Cigarettes/Day",
    "Max_CIGSDAY"         = "Maximum Cigarettes/Day",
    "Percent_with_Asthma" = "Percentage with Asthma Attack"
  )) %>%
  pivot_wider(names_from = Smoking_Intensity, values_from = Value) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))

# Same styling as the first table
final_table <- flipped_table %>%
  kable(
    format   = "html", 
    caption  = "Cigarette Metrics by Smoking Intensity",
    col.names = colnames(.)
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position   = "center"
  )

print(final_table)
```


## Visualization
```{r}
# Bar Chart: Asthma Attack Count by Smoking Status
ggplot(data_cleaned, aes(x = Smoking_Status, fill = as.factor(Asthma_Attack))) +
  geom_bar(position = "dodge") +
  labs(title = "Asthma Attack Frequency by Smoking Status", x = "Smoking Status", y = "Count", fill = "Asthma Attack") +
  theme_minimal() +
  scale_fill_manual(values = c("#1f78b4", "#33a02c"))

# Stacked Bar Chart: Proportion of Asthma Attacks per Smoking Category
ggplot(data_cleaned, aes(x = Smoking_Status, fill = as.factor(Asthma_Attack))) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Asthma Attacks by Smoking Status", x = "Smoking Status", y = "Proportion", fill = "Asthma Attack") +
  theme_minimal() +
  scale_fill_manual(values = c("#1f78b4", "#33a02c"))

# Facet Plot for Smoking Groups
ggplot(data_cleaned, aes(x = Smoking_Status, fill = as.factor(Asthma_Attack))) +
  geom_bar(position = "fill") +
  facet_wrap(~ Smoking_Status) +
  labs(title = "Asthma Attack Proportions by Smoking Status", x = "Smoking Status", y = "Proportion") +
  theme_minimal()
```

## Statistical Analysis
```{r}
# Chi-Square Test
chi_test <- chisq.test(table(data_cleaned$Smoking_Status, data_cleaned$Asthma_Attack))
chi_test
```

## Logistic Regression Model
```{r}
# Run logistic regression
logit_model <- glm(
  Asthma_Attack ~ Smoking_Intensity + gender + age + income + education + region, 
  data = data_cleaned, 
  family = binomial()
)

# Format with robust standard errors and p-values
modelsummary(
  list("Logistic Regression" = logit_model),
  exponentiate = TRUE, 
  stars = c('*' = .1, '**' = .05, '***' = .01),
  output = "html"
)
# To compare with the robust standard error
modelsummary(
  list("Logistic Regression" = logit_model),
  exponentiate = TRUE, 
  vcov = "robust",
  stars = c('*' = .1, '**' = .05, '***' = .01),
  output = "html"
)
```
## Multicollinearity Test
```{r}
# Logistic 
model_interaction <- glm(Asthma_Attack ~ Smoking_Intensity * region + 
                         age + gender + education + income,
                         data = data_cleaned, family = binomial)

summary(model_interaction)
library(car)
vif_model <- glm(Asthma_Attack ~ Smoking_Intensity * region + age + gender + education + income,
                 data = data_cleaned, family = binomial)

vif(vif_model)  

model_no_interaction <- glm(Asthma_Attack ~ Smoking_Intensity + region + 
                            age + gender + education + income,
                            data = data_cleaned, family = binomial)

summary(model_no_interaction)
vif(model_no_interaction)
# We find that multicollinearity has been significantly reduced after change to the noninteraction model, which means the interaction term introduced multicollinearity, inflating standard errors 
```
## Robustness Checks
```{r}
# Probit regress
model_probit <- glm(Asthma_Attack ~ Smoking_Intensity + 
                    age + gender + education + income,
                    data = data_cleaned, family = binomial(link = "probit"))

summary(model_probit)

# LPM regress
model_lpm <- lm(Asthma_Attack ~ Smoking_Intensity + 
                age + gender + education + income,
                data = data_cleaned)

summary(model_lpm)

library(sandwich)
library(lmtest)

# Cluster SE
model_clustered <- glm(Asthma_Attack ~ Smoking_Intensity * region + 
                       age + gender + education + income,
                       data = data_cleaned, family = binomial)

coeftest(model_clustered, vcov = vcovCL, cluster = ~region)
```
## Heterogeneity Test
```{r}
# Define a function to run logistic regression and return ORs
run_logit_by_region <- function(region_name) {
  model <- glm(Asthma_Attack ~ Smoking_Intensity + age + gender + education + income, 
               data = data_cleaned %>% filter(region == region_name), 
               family = binomial)
  
  # Extract coefficients, standard errors, and p-values
  tidy_model <- tidy(model) %>%
    mutate(region = region_name,
           OR = exp(estimate),  # Convert to Odds Ratio
           OR_low = exp(estimate - 1.96 * std.error),  # 95% CI Lower Bound
           OR_high = exp(estimate + 1.96 * std.error), # 95% CI Upper Bound
           p_value = case_when(
             p.value < 0.001 ~ "***",
             p.value < 0.01 ~ "**",
             p.value < 0.05 ~ "*",
             p.value < 0.1 ~ ".",
             TRUE ~ ""
           ),
           OR_formatted = paste0(round(OR, 2), " [", 
                                 round(OR_low, 2), ", ", 
                                 round(OR_high, 2), "] ", p_value))
  
  return(tidy_model)
}

# Run logistic regressions for each region
regions <- c("Northeast", "Midwest", "South", "West")
results_list <- lapply(regions, run_logit_by_region)

# Combine results into a single dataframe
results_df <- bind_rows(results_list)

# Pivot the results to make a side-by-side comparison table
results_table <- results_df %>%
  select(term, region, OR_formatted) %>%
  pivot_wider(names_from = region, values_from = OR_formatted)

# Create a nicely formatted table using kableExtra
results_table %>%
  kable("html", caption = "Odds Ratios (OR) for Asthma Across Regions") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

```
## Heterogeneity Test for the sex
```{r}
# Define a function to run logistic regression and return ORs
run_logit_by_gender <- function(gender_name) {
  model <- glm(Asthma_Attack ~ Smoking_Intensity + age + education + income + region, 
               data = data_cleaned %>% filter(gender == gender_name), 
               family = binomial)
  
  # Extract coefficients, standard errors, and p-values
  tidy_model <- tidy(model) %>%
    mutate(gender = gender_name,
           OR = exp(estimate),  # Convert to Odds Ratio
           OR_low = exp(estimate - 1.96 * std.error),  # 95% CI Lower Bound
           OR_high = exp(estimate + 1.96 * std.error), # 95% CI Upper Bound
           p_value = case_when(
             p.value < 0.001 ~ "***",
             p.value < 0.01 ~ "**",
             p.value < 0.05 ~ "*",
             p.value < 0.1 ~ ".",
             TRUE ~ ""
           ),
           OR_formatted = paste0(round(OR, 2), " [", 
                                 round(OR_low, 2), ", ", 
                                 round(OR_high, 2), "] ", p_value))
  
  return(tidy_model)
}

# Run logistic regressions for Male and Female separately
genders <- c("Male", "Female")
results_list <- lapply(genders, run_logit_by_gender)

# Combine results into a single dataframe
results_df <- bind_rows(results_list)

# Pivot the results to make a side-by-side comparison table
results_table <- results_df %>%
  select(term, gender, OR_formatted) %>%
  pivot_wider(names_from = gender, values_from = OR_formatted)

# Create a nicely formatted table using kableExtra
results_table %>%
  kable("html", caption = "Odds Ratios (OR) for Asthma by Gender") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```
## Residual Plot for Logistic Regression
```{r}
# Extract residuals and fitted values
residuals_data <- data.frame(
  Fitted = fitted(logit_model),
  Residuals = residuals(logit_model)
)

# Plot residuals
ggplot(residuals_data, aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residual Plot: Logistic Regression", x = "Fitted Values", y = "Residuals") +
  theme_minimal()
```

## Predicted Probabilities Distribution
```{r}
# Get predicted probabilities
data_cleaned$pred_prob <- predict(logit_model, type = "response")

# Plot histogram
ggplot(data_cleaned, aes(x = pred_prob)) +
  geom_histogram(binwidth = 0.05, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Distribution of Predicted Probabilities", x = "Predicted Probability", y = "Count")
```

## Marginal Effects for Logistic Regression
```{r}
# Compute marginal effects for logistic regression
marginal_effects <- margins(logit_model)

# Summarize Average Marginal Effects
summary(marginal_effects)
```

## Interpretation
The logistic regression results above provide insights into the relationship between smoking status and the likelihood of having an asthma attack in the past 12 months. The confidence intervals and significance levels indicate the strength of this relationship. Further investigation can include additional covariates to control for confounding factors.